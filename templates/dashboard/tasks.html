<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ session.get('username', 'Player') }} â€” Tasks</title>

  <style>
    :root {
      --bg: #050615;
      --panel: #0f1630;
      --card: #0a1224;
      --accent: #00d0ff;
      --muted: #9fb2c4;
      --alert: #ff8fa3;
      --font-primary: 'Inter', "Segoe UI", Roboto, sans-serif;
      --radius-xl: 12px;
    }
    * { box-sizing: border-box; }
    body, html {
      margin:0; padding:0; height:100%; width:100%;
      font-family: var(--font-primary); background: var(--bg); color: var(--accent); display:flex;
    }
    .sidebar { width:220px; background: var(--panel); padding:20px; display:flex; flex-direction:column; justify-content:space-between; gap:12px; box-shadow:4px 0 20px rgba(0,0,0,0.5); }
    .logo { font-size:20px; font-weight:700; text-align:center; color:var(--accent); }
    .nav { display:flex; flex-direction:column; gap:10px; margin-top:10px; }
    .nav a { text-decoration:none; color:var(--accent); padding:8px; border-radius:10px; font-weight:600; }
    .nav a.active { background: rgba(0,208,255,0.08); box-shadow: inset 0 0 12px rgba(0,208,255,0.03); }
    .logout button { padding:10px 12px; border:none; border-radius:10px; background:var(--alert); color:#fff; cursor:pointer; font-weight:600; }

    .main { flex:1; padding:28px; display:flex; flex-direction:column; gap:18px; min-height:100vh; }
    .header-row { display:flex; justify-content:space-between; align-items:center; gap:12px; }
    h1 { margin:0; color:var(--accent); font-size:22px; }
    .points-badge { background: var(--card); padding:8px 12px; border-radius:12px; font-weight:700; color: var(--accent); }

    .board { display:grid; grid-template-columns:1fr 340px; gap:18px; align-items:start; }
    .left-card, .right-card { background: var(--panel); padding:16px; border-radius: var(--radius-xl); box-shadow:0 8px 20px rgba(0,0,0,0.5); }
    .left-card h3, .right-card h3 { margin-top:0; color:var(--accent); }

    .form-row { display:flex; gap:10px; align-items:center; margin-top:8px; }
    .form-row input { padding:10px; border-radius:10px; border:none; background:var(--card); color:var(--accent); outline:none; font-size:14px; }
    .btn { padding:10px 12px; border-radius:10px; border:none; background:var(--accent); color:#001; cursor:pointer; font-weight:700; }

    .tasks-list { margin-top:12px; max-height:400px; overflow:auto; display:flex; flex-direction:column; gap:8px; }
    .task-item { display:flex; justify-content:space-between; gap:12px; align-items:center; background: var(--card); padding:12px; border-radius:10px; color:var(--muted); }
    .task-title { color:var(--accent); font-weight:600; }
    .task-meta { font-size:13px; color:var(--muted); }
    .task-actions { display:flex; gap:8px; }
    .task-actions .btn { padding:6px 8px; font-size:13px; }
    .btn-complete { background:#2ad19f; color:#001; }
    .btn-delete { background:#ff6b87; color:#fff; }
    .small { font-size:13px; color:var(--muted); }

    @media (max-width:900px) { .board { grid-template-columns:1fr; } .sidebar { display:none; } }

    .voice-btn {
      background-color: #0a0c14; color: #00e5ff;
      border: 2px solid #00e5ff; padding: 10px 20px;
      border-radius: 8px; font-size: 16px; cursor: pointer; transition: 0.3s;
    }
    .voice-btn:hover { background-color: #00e5ff; color: #0a0c14; }
  </style>
</head>
<body>

  <div class="sidebar">
    <div>
      <div class="logo">Sam AI</div>
      <nav class="nav">
        <a href="{{ url_for('profile') }}">Profile</a>
        <a class="active" href="{{ url_for('tasks_page') }}">Tasks</a>
        <a href="{{ url_for('academics') }}">Academics</a>
        <a href="{{ url_for('quests_page') }}">Quests</a>
        <a href="{{ url_for('developers') }}">Developers</a>
      </nav>
    </div>
    <div>
      <form action="{{ url_for('logout') }}" method="post">
        <button type="submit">Logout</button>
      </form>
    </div>
  </div>

  <!-- Floating Voice Assistant Button -->
  <!-- Floating Voice Button -->
<button id="micBtn" style="
  position: fixed; bottom: 20px; right: 20px; 
  width: 60px; height: 60px; border-radius: 50%;
  background: #00d0ff; color: #050615; font-size: 28px;
  border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
  ðŸŽ¤
</button>

<!-- Voice Assistant Feedback -->
<div id="voiceResponse" style="
  position: fixed; bottom: 100px; right: 20px;
  background: #0f1630; color: #00d0ff;
  padding: 12px 16px; border-radius: 12px; 
  display: none; max-width: 280px;">
</div>


  <div class="main">
    <div class="header-row">
      <h1>Tasks</h1>
      <div class="points-badge">Points: <span id="points">{{ user.points or 0 }}</span></div>
    </div>

    <div class="board">
      <div class="left-card">
        <h3>Add Task</h3>
        <form id="task-form" class="form-row" method="POST" action="{{ url_for('add_task') }}">
          <input type="text" name="title" placeholder="Enter task..." required>
          <input type="datetime-local" name="time">
          <button class="btn" type="submit">Add</button>
        </form>

        <h3 style="margin-top:18px;">Your Tasks</h3>
        <div class="tasks-list" id="tasksList">
          {% for task in tasks %}
          <div class="task-item" data-id="{{ task['id'] }}">
            <div>
              <div class="task-title">{{ task['title'] }}</div>
              <div class="task-meta">
                {% if task['due_time'] %}
                  {{ task['due_time'].strftime('%Y-%m-%d %H:%M') }}
                {% elif task['alarm_time'] %}
                  {{ task['alarm_time'].strftime('%Y-%m-%d %H:%M') }}
                {% endif %}
                â€¢ {{ 'Completed' if task['completed'] else 'Pending' }}
              </div>
            </div>

            <div class="task-actions">
              {% if not task['completed'] %}
                <button class="btn btn-complete" onclick="completeTask({{ task['id'] }}, this)">Complete</button>
              {% else %}
                <span class="small" style="color:#2ad19f;">âœ” Completed</span>
              {% endif %}

              <form method="POST" action="{{ url_for('delete_task', task_id=task['id']) }}" style="display:inline;">
                <button class="btn btn-delete" type="submit">Delete</button>
              </form>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <div class="right-card">
        <h3>Overview</h3>
        <div class="small">Local time: <span id="localTime"></span></div>
        <div style="margin-top:12px;">
          <div class="small">Active reminders will ring at due time.</div>
        </div>
      </div>
    </div>
  </div>

  <audio id="alarmSound" src="{{ url_for('static', filename='alarm-301729.mp3') }}" preload="auto"></audio>

  <script>
    function updateLocalTime() {
      const now = new Date();
      document.getElementById('localTime').textContent = now.toLocaleString();
    }
    setInterval(updateLocalTime, 1000);
    updateLocalTime();

    async function completeTask(taskId, btn) {
      btn.disabled = true;
      try {
        const res = await fetch(`/complete_task/${taskId}`, { method: 'POST' });
        const data = await res.json();

        if (data.success) {
          document.getElementById('points').textContent = data.points;

          const completedSpan = document.createElement('span');
          completedSpan.classList.add('small');
          completedSpan.style.color = '#2ad19f';
          completedSpan.textContent = 'âœ” Completed';
          btn.replaceWith(completedSpan);

          const meta = btn.closest('.task-item').querySelector('.task-meta');
          if (meta) meta.innerHTML = meta.innerHTML.replace(/Pending/g, 'Completed');
        } else {
          btn.disabled = false;
          alert('Error completing task');
        }
      } catch (e) {
        btn.disabled = false;
        console.error(e);
        alert('Server error');
      }
    }
  </script>

  <script src="{{ url_for('static', filename='js/voice_assistant.js') }}"></script>
</body>
</html>
